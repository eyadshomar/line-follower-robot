#include <SoftwareSerial.h>
#include <Wire.h>
#include <LiquidCrystal_I2C.h>
// setting up lcd
LiquidCrystal_I2C lcd(0x27,16,2);
int RX=0, TX=1;
// setting up bluetooth
SoftwareSerial BTserial(RX, TX);

void setup_lcd(){
  lcd.init();
  lcd.backlight();
  lcd.setCursor(0,0);
}

void setup_Bluetooth(){
  BTserial.begin(9600);
  Serial.begin(9600);
  Serial.println("Arduino is ready");
  pinMode(RX,INPUT);
  pinMode(TX,OUTPUT);
 // lcd.print("Set!");
}
int i;
// Ultrasound variables
int cm ;
long ti;
// PWM values
int k = 180 ,z = 150 ;  
// LM=Left Motor, RM=Right Motor, FL=Front Led, RL=Right Led, LL=Left Led, BL=Back Led                                                                              
// RIR=Right InfraRed sensor, LIR=Left InfraRed sensor
int LM2=2, LM1=3, RM1=4, RM2=5, FL=6, RL=7, BL=8, LL=9, duration=1000, RIR=A2, LIR=A1;
// TP=Trigger Pin, EP=Echo Pin;
int TP=12, EP=11;
int InnerLED=A0;
void setup() {
  setup_lcd();
  setup_Bluetooth();
  // put your setup code here, to run once:
  pinMode(LM1, OUTPUT);
  pinMode(LM2, OUTPUT);
  pinMode(RM1, OUTPUT);
  pinMode(RM2, OUTPUT);
  pinMode(FL, OUTPUT);
  pinMode(RL, OUTPUT);
  pinMode(BL, OUTPUT);
  pinMode(LL, OUTPUT);
  pinMode(RIR, INPUT);
  pinMode(LIR, INPUT);
  pinMode(TP, OUTPUT);
  pinMode(EP, INPUT);
  pinMode(InnerLED, OUTPUT);
}

void drive(int m1,int m2,int m3,int m4)
{
  int front_lights, back_lights, right_lights, left_lights, motor1, motor2, motor3, motor4;
  //motor1 and motor2 for left motor, motor3 and motor4 for right motor.
  //motor1 and motor3 are forward, motor2 and motor4 are backward.
  //dir: 1010 = forward, 1000 = right, 0101 = backward, 0010 = left, 0000 = stop.
  //Note: There are other inputs that can cause the robot to go right, left, or stop.
  front_lights = (m1)&&(!m2)&&(m3)&&(!m4);
  back_lights = (!m1)&&(m2)&&(!m3)&&(m4);
  right_lights = (m1&&(!m2)&&(!m3))||((!m1)&&(!m2)&&m4)||(m1&&(!m3)&&m4)||((!m2)&&(!m3)&&m4);
  left_lights = ((!m1)&&m2&&m3)||((!m1)&&m2&&(!m4))||((!m1)&&m3&&(!m4))||(m2&&m3&&(!m4));
  digitalWrite (FL, front_lights);
  digitalWrite (RL, right_lights);
  digitalWrite (BL, back_lights);
  digitalWrite (LL, left_lights);
  analogWrite(LM1, m1*180);
  analogWrite(LM2, m2*180);
  analogWrite(RM1, m3*150);
  analogWrite(RM2, m4*150);
}

void loop() {
  // put your main code here, to run repeatedly:
  
  // Ultrasound function
  int x,y;
  digitalWrite(TP, LOW);
  delayMicroseconds(2);
  digitalWrite(TP, HIGH);
  delayMicroseconds(10);
  digitalWrite(TP, LOW);
  ti = pulseIn(EP, HIGH);
  cm = ti*0.034/2;


 // In case of an obstacle in the way
 if (cm < 14) {
  drive(0,0,0,0);
lcd.clear();
lcd.print("obstacle!");
  Serial.println("Dear user,");
  Serial.println("The vehicle is facing an obstacle.");
  Serial.println("Please remove it, so the vehicle could continue its ride.");
  Serial.println("Thank you in advance.");
  delay(100);
  while(cm<14){
    digitalWrite(InnerLED,HIGH);
    delay(50);
    digitalWrite(InnerLED,LOW);
    delay(50);
    digitalWrite(TP, LOW);
    delayMicroseconds(2);
    digitalWrite(TP, HIGH);
    delayMicroseconds(10);
    digitalWrite(TP, LOW);
    ti = pulseIn(EP, HIGH);
    cm = ti*0.034/2;
  }
lcd.clear();
 }
 else{
    // Infrared sensor function  
    x = digitalRead(RIR);
    y = digitalRead(LIR);
    if (x ==1 && y==0){
      drive(1,0,0,0);
    }
    if( x==0 && y == 1){
      drive (0,0,1,0);
      
    }
    if ((x == 0) && (y == 0)){
      drive(1,0,1,0); 
    }
    if ((x == 1) &&(y == 1)){
      drive (0,0,0,0);
  }
 }  
     
  }
